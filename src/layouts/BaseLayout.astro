---
import { ViewTransitions } from 'astro:transitions';
import BaseHead, { type Props as HeadProps } from '../components/BaseHead.astro';
import Footer from '../components/Footer.astro';
import Header from '../components/Header.astro';
import ThemeToggle from '../components/ThemeToggle.astro';

export type Props = HeadProps;

const { title, description, image, ...head } = Astro.props;
---

<!doctype html>
<html lang="es" class="h-full antialiased">
    <head>
        <BaseHead title={title} description={description} image={image} />
        <ViewTransitions />
    </head>
    <body class="flex h-full flex-col dark:bg-black dark:text-white">
        <Header />

        <main class="w-full flex-auto pt-[96px]">
            <slot />
        </main>

        <Footer />

        <div class="fixed bottom-6 right-6 z-50 hidden md:block">
            <ThemeToggle />
        </div>
        <script is:inline>
        // Lógica unificada para establecer y mantener el tema en cada carga o cambio de página
        (function() {
            function setThemeIcon(isDark) {
                document.querySelectorAll('#icon-sun').forEach(el => el.classList.toggle('hidden', isDark));
                document.querySelectorAll('#icon-moon').forEach(el => el.classList.toggle('hidden', !isDark));
            }
            function getCurrentTheme() {
                if (typeof localStorage !== 'undefined' && localStorage.getItem('theme')) {
                    return localStorage.getItem('theme');
                }
                if (window.matchMedia('(prefers-color-scheme: dark)').matches) {
                    return 'dark';
                }
                return 'light';
            }
            function applyTheme(theme) {
                if (theme === 'dark') {
                    document.documentElement.classList.add('dark');
                    setThemeIcon(true);
                } else {
                    document.documentElement.classList.remove('dark');
                    setThemeIcon(false);
                }
                if (typeof localStorage !== 'undefined') {
                    localStorage.setItem('theme', theme);
                }
            }
            // Aplica el tema al cargar o cambiar de página
            function syncTheme() {
                const theme = getCurrentTheme();
                applyTheme(theme);
            }
            syncTheme();
            // Permite cambiar el tema manualmente
            document.querySelectorAll('#theme-toggle').forEach(btn => {
                btn.onclick = function() {
                    const isDark = !document.documentElement.classList.contains('dark');
                    document.documentElement.classList.toggle('dark', isDark);
                    localStorage.setItem('theme', isDark ? 'dark' : 'light');
                    setThemeIcon(isDark);
                };
            });
            // Sincroniza el tema si cambia en otra pestaña
            window.addEventListener('storage', syncTheme);
            // Reaplica el tema en cada navegación SPA de Astro
            window.addEventListener('astro:page-load', syncTheme);
            // Escucha cambios de preferencia del sistema
            window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', function(e) {
                if (!localStorage.getItem('theme')) {
                    syncTheme();
                }
            });
        })();
        </script>
    </body>
</html>
